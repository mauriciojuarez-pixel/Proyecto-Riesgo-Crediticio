<!-- frontend/src/views/risk.ejs -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Evaluación de Riesgo - Riesgo Crediticio</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .resultado {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .resultado.exito {
            background-color: #d4edda;
            color: #155724;
        }
        .resultado.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <nav>
        <span>Bienvenido, <%= user ? user.username : 'Invitado' %></span>
        <a href="/auth/logout">Cerrar Sesión</a>
    </nav>

    <div class="container">
        <h1>Evaluación de Riesgo Crediticio</h1>

        <% if (error) { %>
            <div class="resultado error"><%= error %></div>
        <% } %>

        <form id="riskForm">
            <input type="number" name="ingreso" placeholder="Ingreso mensual" step="0.01" required>
            <input type="number" name="deuda_ratio" placeholder="Ratio de deuda (%)" step="0.01" required>
            <input type="number" name="antiguedad" placeholder="Años de antigüedad laboral" required>
            <input type="number" name="estabilidad_laboral" placeholder="Estabilidad laboral (1-5)" min="1" max="5" required>
            <button type="submit">Evaluar Riesgo</button>
        </form>

        <div class="resultado" id="resultado"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("riskForm");
            const resultadoDiv = document.getElementById("resultado");

            if (!form) return;

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                resultadoDiv.textContent = "Evaluando riesgo...";
                resultadoDiv.className = "resultado";

                const formData = new FormData(form);
                const datos = Object.fromEntries(formData.entries());

                // Convertir a números
                datos.ingreso = parseFloat(datos.ingreso);
                datos.deuda_ratio = parseFloat(datos.deuda_ratio);
                datos.antiguedad = parseInt(datos.antiguedad);
                datos.estabilidad_laboral = parseInt(datos.estabilidad_laboral);

                try {
                    const res = await fetch("/risk/predict", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(datos)
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        resultadoDiv.textContent = "Error: " + (data.error || "No se pudo evaluar");
                        resultadoDiv.classList.add("error");
                        return;
                    }

                    // Mostrar resultados del modelo
                    resultadoDiv.textContent = `Nivel de riesgo: ${data.riesgo || 'Indefinido'}\nScore: ${data.score || '-'}`;
                    resultadoDiv.classList.add("exito");

                } catch (err) {
                    console.error("Error frontend:", err);
                    resultadoDiv.textContent = "Error de conexión con el servidor";
                    resultadoDiv.classList.add("error");
                }
            });
        });
    </script>
</body>
</html>
